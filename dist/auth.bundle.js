document.addEventListener("DOMContentLoaded",(function(){var e,t,n=document.getElementById("registerForm"),o=document.getElementById("loginForm"),r=document.getElementById("showLogin"),a=document.getElementById("showRegister"),l=document.getElementById("registerButton"),i=document.getElementById("loginButton");function s(e,t){e.classList.add("border-red-500");var n=document.createElement("p");n.textContent=t,n.className="text-red-500 text-xs mt-1",e.parentNode.insertBefore(n,e.nextSibling)}function c(){document.querySelectorAll(".text-red-500").forEach((function(e){return e.remove()})),document.querySelectorAll(".border-red-500").forEach((function(e){return e.classList.remove("border-red-500")}))}function d(e,t){e.classList.remove("hidden"),t.classList.add("hidden")}document.getElementById("loginEmail").focus(),e=localStorage.getItem("rememberedEmail"),t=localStorage.getItem("rememberedPassword"),e&&t&&(document.getElementById("loginEmail").value=e,document.getElementById("loginPassword").value=t,document.getElementById("rememberMe").checked=!0),setTimeout((function(){chrome.storage.local.get(["userEmail","loginExpiration"],(function(e){console.log("AUTOCHECK LOGIN",e),e.userEmail&&e.loginExpiration&&((new Date).getTime()<e.loginExpiration?(console.log("Auto-login successful"),chrome.storage.local.get(["tabZalo"],(function(e){var t=e.tabZalo.id;chrome.tabs.sendMessage(t,{task:"CHANGE_PAGE",page:"../page/popup.html"})}))):(chrome.storage.local.remove(["userEmail","loginExpiration"]),chrome.storage.local.get(["tabZalo"],(function(e){var t=e.tabZalo.id;chrome.tabs.sendMessage(t,{task:"CHANGE_PAGE",page:"../page/login.html"})}))))}))}),2e3),r.addEventListener("click",(function(e){e.preventDefault(),d(o,n),$("#loginEmail").focus()})),a.addEventListener("click",(function(e){e.preventDefault(),d(n,o),$("#regEmail").focus()})),l.addEventListener("click",(function(){c();var e=document.getElementById("regEmail").value,t=document.getElementById("regPassword").value,r=document.getElementById("regPhone").value,a=document.getElementById("regAddress").value,l=document.getElementById("regPlan").value,i=document.getElementById("regFullname").value;if(0!=e.length)if(0!=function(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}(e))if(t.length<5)$("#regPassword").notify("Mật khẩu ít nhất phải 5 ký tự.","error");else if(0!=i.length)if(0!=r.length)if(0!=a.length)if("-1"!==l){var s=new URLSearchParams;s.append("email",e),s.append("password",t),s.append("phone",r),s.append("address",a),s.append("plan",l),s.append("fullname",i),s.append("app_id",1),fetch("https://key.laptrinhvb.net/api/register",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:s}).then((function(e){return e.json()})).then((function(r){r.status?($.notify(r.message,"success"),d(o,n),$("#loginEmail").focus(),$("#loginEmail").val(e),$("#loginPassword").val(t),function(){for(var e=document.getElementById("registerForm"),t=e.getElementsByTagName("input"),n=0;n<t.length;n++)switch(t[n].type){case"text":case"password":case"email":case"number":case"date":case"tel":t[n].value="";break;case"checkbox":case"radio":t[n].checked=!1}var o=e.getElementsByTagName("select");for(n=0;n<o.length;n++)o[n].selectedIndex=0;var r=e.getElementsByTagName("textarea");for(n=0;n<r.length;n++)r[n].value=""}()):$.notify("Đăng ký thất bại: "+r.message,"error")})).catch((function(e){console.error("Error:",e),$.notify("Có lỗi xảy ra khi đăng ký","error")}))}else $("#regPlan").notify("Bạn chưa chọn gói đăng ký.","error");else $("#regAddress").notify("Điền địa chỉ của bạn.","error");else $("#regPhone").notify("Điền số điện thoại của bạn.","error");else $("#regFullname").notify("Điền tên của bạn.","error");else $("#regEmail").notify("Email không hợp lệ.","error");else $("#regEmail").notify("Điền email của bạn.","error")})),document.getElementById("loginPassword").addEventListener("keypress",(function(e){"Enter"===e.key&&(e.preventDefault(),i.click())})),$(document).on("keypress",(function(e){13==e.which&&(event.preventDefault(),i.click())})),i.addEventListener("click",(function(){c();var e=document.getElementById("loginEmail"),t=document.getElementById("loginPassword"),n=!0;if(e.value||(s(e,"Email is required"),n=!1),t.value||(s(t,"Password is required"),n=!1),n){var o=new URLSearchParams;o.append("email",e.value),o.append("password",t.value),o.append("app_id",1),fetch("https://key.laptrinhvb.net/api/auth",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o.toString(),redirect:"manual"}).then((function(e){if("opaqueredirect"===e.type)throw new Error("Redirect detected");return e.ok?e.json():e.json().then((function(e){throw new Error(e.message||"An error occurred")}))})).then((function(t){if(t.status){console.log("Login successful"),function(){var e=document.getElementById("loginEmail").value,t=document.getElementById("loginPassword").value;document.getElementById("rememberMe").checked?(localStorage.setItem("rememberedEmail",e),localStorage.setItem("rememberedPassword",t)):(localStorage.removeItem("rememberedEmail"),localStorage.removeItem("rememberedPassword"))}();var n=new Date;n.setDate(n.getDate()+1),chrome.storage.local.set({userEmail:e.value,loginExpiration:n.getTime()},(function(){console.log("Login info saved"),chrome.storage.local.get(["tabZalo"],(function(e){var t=e.tabZalo.id;chrome.tabs.sendMessage(t,{task:"CHANGE_PAGE",page:"../page/popup.html"})}))}))}else console.log("Login failed"),s(e,t.message)})).catch((function(t){console.error("Fetch error:",t),s(e,"An error occurred. Please try again.")}))}}))}));